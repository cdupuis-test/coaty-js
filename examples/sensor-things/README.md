# Coaty - Sensor Things Example

[![Powered by Coaty](https://img.shields.io/badge/Powered%20by-Coaty-FF8C00.svg)](https://coaty.io)
[![License](https://img.shields.io/badge/License-MIT-blue.svg)](https://opensource.org/licenses/MIT)

## Table of Contents

* [Introduction](#introduction)
* [Installation](#installation)
  * [Install and build the sensor](#install-and-build-the-sensor)
  * [Install and build the dashboard](#install-and-build-the-dashboard)
* [Start-up](#start-up)
* [Project structure](#project-structure)
* [Components](#components)
  * [Dashboard](#dashboard)
  * [Sensor](#sensor)

## Introduction

_This README assumes you are already familiar with
[Sensor Things API](https://coatyio.github.io/coaty-js/man/sensor-things-guide/)
and [Coaty communication](https://coatyio.github.io/coaty-js/man/communication-protocol/)._

The SensorThings example demonstrates how Coaty and the SensorThings API can be used
to manage a self-discovering network of sensors.

This example is composed of:

* a web dashboard to explore the sensor network
* one configurable thing. Create any number of sensors for a better result.

**Note :** Any thing and sensor using the SensorThings API and Coaty can be used with this example.
In fact, dashboard knows nothing specific about things and sensors. It just listens to `Advertise` events on
`Thing` and `Sensor` objects and update its list of available things and sensors. Thus to be available
on the dashboard, a sensor just has to advertise its associated Thing and respect the
SensorThings standard.

## Installation

This example comes bundled with the Coaty framework but it can be
build and run independently. The example has its own npm package definition
and a simple build environment based on npm scripts.

To begin with, make sure that the `Node.js` JavaScript runtime (version 6 or higher) is globally
installed on your target machine. Download and installation details can be found
[here](http://nodejs.org/).

Then, checkout the SensorThings example sources from
[https://github.com/coatyio/coaty-js/tree/master/examples/sensor-things](https://github.com/coatyio/coaty-js/tree/master/examples/sensor-things).

### Install and build the sensor

```sh
cd sensor
npm install
npm run build
```

### Install and build the dashboard

```sh
cd dashboard
npm install
npm run build
```

### Install the broker

Before starting the SensorThings example, you need an MQTT broker listening on
port 1883 and websocket port 9883. To make this example ready to use, the `broker`
folder defines an npm package definition which uses the broker scripts provided by
the Coaty framework.

To make it usable, just run

```sh
cd broker
npm install
```

To easily trace communication events distributed by the SensorThings application,
this broker logs any MQTT messages to the console. Note that you should **not**
use this broker as is for production purposes.

## Start-up

Once components are installed and built, execute `cd broker && npm start` to
start the MQTT broker.

To start a sensor, execute `cd sensor && npm start` in a separate
console window. You will then have to configure your sensor.

To start the dashboard, execute `cd dashboard && npm start` in a separate
console window.

## Project Structure

Here is the file structure of the SensorThings example. To keep it readable,
only main files are displayed:

```
.
├── dashboard/
│   ├── ....                                 - Angular infrastructure
│   └── src/
│      └── app
│           ├── ...                          - miscellaneous resources for browser app
│           ├── agent.config.ts              - dashboard agent configuration
|           ├── agent.info.ts                - sensor agent info auto-generated by build script
│           ├── app.component.ts|.html|.scss - Angular root component
│           ├── app.module.ts                - Angular module definition
│           ├── app-routing.module.ts        - Angular routing configuration
│           ├── main.ts                      - Angular bootstrap file, augmented with Coaty integration
|           └── controller/                  - custom controllers
│               ├── sensor-things-controller.ts  - Coaty controller for sensors and things
|           └── pipes/                       - custom Angular pipes
│           └── sensor/                      - Sensor network page
|           |   ├── object-network.component.ts    - Displays the object graph
│           |   ├── sensor.component.ts      - HTML template for object page
│           |   └── sensor.component.ts      - business logic for object page. Contains self discovery algorithm.
│           └── welcome/                     - start page for selecting things
│              ├── welcome.component.html    - HTML template for thing selection page
│              └── welcome.component.ts      - business logic for thing selection page
├── broker/
│   └── package.json                         - npm script to start Coaty development broker
├── README.md                                - this document
└── sensor/
    ├── gulpfile.js                          - gulp tasks to build and lint the sensor service
    ├── package.json                         - sensor dependencies
    └── src/
        ├── agent.ts                         - sensor agent entrypoint
        ├── agent.config.ts                  - sensor agent configuration
        ├── agent.info.ts                    - sensor agent info auto-generated by build script
        └── sensor-thing-controller.ts       - sensor agent business logic

```

Each component of the example is designed to run independantly, thus each folder
can be run on its own. It also means that if you use a non-standard MQTT broker
configuration, you will have change the parameters in each component configuration
file.

More details about generated `agent.info.ts` and its usage can be found in the
[Hello World example documentation](https://github.com/coatyio/coaty-js/tree/master/examples/hello-world/README.md#project-structure).

## Components

### Dashboard

Dashboard web app is just a viewer for sensors and related objects. It displays the
available sensors and allows to dive into their object networks by clicking on their name.

Once a sensor is selected, the dashboard observes incoming observations on the channel of
the sensor. The network of sensors is discovered using these observations.

The dashboard web app is build with Angular and Angular CLI. For details, see the
[README](https://github.com/coatyio/coaty-js/tree/master/examples/sensor-things/dashboard/README.md)
in its project folder.

### Sensor

Sensor script simulates the behaviour of a sensor. Once launched, customize your sensor by
defining a name and location and choosing which metric monitor among Load average,
Free memory, Uptime metric. Once those parameters are set, a Sensor for each one is created.
All sensors are then connected to one single Thing that is created at the beginning.

Each sensor will:

* publish sensor data every 5 seconds on its channel (channelId is the objectId of the Sensor),
* listen to discover events and resolve them if the discovered id refers to one of its
  related object.

Default settings can be changed in `sensor/agent.ts`.

You can build your own SensorThings compliant sensor script and use it with the dashboard.
You just need to advertise your associated Thing at least once.

---
Copyright (c) 2018 Siemens AG. This work is licensed under a
[Creative Commons Attribution-ShareAlike 4.0 International License](http://creativecommons.org/licenses/by-sa/4.0/).
